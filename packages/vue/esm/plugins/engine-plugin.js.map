{"version":3,"file":"engine-plugin.js","sources":["../../src/plugins/engine-plugin.ts"],"sourcesContent":["/**\n * Device Engine Plugin\n * \n * 将 Device 功能集成到 LDesign Engine\n * \n * @example\n * ```ts\n * import { createVueEngine } from '@ldesign/engine-vue3'\n * import { createDeviceEnginePlugin } from '@ldesign/device-vue/plugins'\n * \n * const engine = createVueEngine({\n *   plugins: [\n *     createDeviceEnginePlugin({\n *       enableResize: true,\n *       enableOrientation: true,\n *       modules: ['network', 'battery'],\n *     })\n *   ]\n * })\n * ```\n */\nimport type { DeviceDetector } from '@ldesign/device-core'\nimport { DeviceDetector as CoreDeviceDetector } from '@ldesign/device-core'\nimport { createDevicePlugin } from '../plugin'\n\n/**\n * Engine Plugin 接口 (临时定义,等待 @ldesign/engine-core 包)\n */\nexport interface Plugin<Options = Record<string, unknown>> {\n  readonly name: string\n  readonly version?: string\n  readonly dependencies?: string[]\n  install: (context: PluginContext, options?: Options) => void | Promise<void>\n  uninstall?: (context: PluginContext) => void | Promise<void>\n}\n\n/**\n * Plugin API 接口\n */\nexport interface PluginAPI {\n  name: string\n  version: string\n  [key: string]: unknown\n}\n\n/**\n * Plugin Context 接口 (临时定义)\n */\nexport interface PluginContext {\n  engine: {\n    state: {\n      set: (key: string, value: unknown) => void\n      get: (key: string) => unknown\n      delete: (key: string) => void\n    }\n    api: {\n      /** 注册插件 API，接收包含 name 和 version 的对象 */\n      register: (api: PluginAPI) => void\n      get: (name: string) => unknown\n      unregister: (name: string) => void\n    }\n    events: {\n      emit: (event: string, data?: unknown) => void\n      on: (event: string, handler: (data?: unknown) => void) => void\n      off: (event: string, handler: (data?: unknown) => void) => void\n    }\n    getApp: () => unknown\n  }\n}\n\n/**\n * Device Engine 插件选项\n */\nexport interface DeviceEnginePluginOptions {\n  /** 插件名称 */\n  name?: string\n  /** 插件版本 */\n  version?: string\n  /** 是否启用调试 */\n  debug?: boolean\n  /** 设备检测器配置 */\n  enableResize?: boolean\n  enableOrientation?: boolean\n  modules?: string[]\n  /** Vue 插件配置 */\n  globalPropertyName?: string\n  registerComponents?: boolean\n  registerDirectives?: boolean\n}\n\n/**\n * 创建 Device Engine 插件\n * \n * @param options - 插件配置选项\n * @returns Engine Plugin\n */\nexport function createDeviceEnginePlugin(\n  options: DeviceEnginePluginOptions = {}\n): Plugin {\n  const {\n    name = 'device',\n    version = '1.0.0',\n    debug = false,\n    enableResize = true,\n    enableOrientation = true,\n    modules = ['network', 'battery'],\n    globalPropertyName = '$device',\n    registerComponents = true,\n    registerDirectives = true,\n  } = options\n\n  return {\n    name,\n    version,\n\n    async install(context: PluginContext) {\n      const { engine } = context\n\n      if (debug) {\n        console.log('[Device Plugin] Installing...')\n      }\n\n      // 1. 创建设备检测器实例\n      const detector = new CoreDeviceDetector({\n        enableResize,\n        enableOrientation,\n      })\n\n      // 2. 加载模块\n      for (const moduleName of modules) {\n        try {\n          await detector.loadModule(moduleName)\n          if (debug) {\n            console.log(`[Device Plugin] Module loaded: ${moduleName}`)\n          }\n        }\n        catch (error) {\n          console.warn(`[Device Plugin] Failed to load module: ${moduleName}`, error)\n        }\n      }\n\n      // 3. 注册到 Engine State (全局状态)\n      engine.state.set('device:instance', detector)\n      engine.state.set('device:info', detector.getDeviceInfo())\n\n      // 4. 注册到 Engine API (API 访问)\n      engine.api.register({\n        name,\n        version,\n\n        /** 获取设备检测器实例 */\n        getInstance: () => detector,\n\n        /** 获取设备信息 */\n        getDeviceInfo: () => detector.getDeviceInfo(),\n\n        /** 获取设备类型 */\n        getDeviceType: () => detector.getDeviceInfo().type,\n\n        /** 是否移动设备 */\n        isMobile: () => detector.getDeviceInfo().type === 'mobile',\n\n        /** 是否平板设备 */\n        isTablet: () => detector.getDeviceInfo().type === 'tablet',\n\n        /** 是否桌面设备 */\n        isDesktop: () => detector.getDeviceInfo().type === 'desktop',\n\n        /** 刷新设备信息 */\n        refresh: () => {\n          const info = detector.getDeviceInfo()\n          engine.state.set('device:info', info)\n          return info\n        },\n      })\n\n      // 5. 监听设备变化,更新 Engine State\n      detector.on('deviceChange', (info) => {\n        engine.state.set('device:info', info)\n        engine.events.emit('device:change', info)\n      })\n\n      detector.on('orientationChange', (orientation) => {\n        engine.events.emit('device:orientation-change', orientation)\n      })\n\n      // 6. 安装 Vue 插件\n      const app = engine.getApp()\n      if (app && typeof app === 'object' && 'use' in app) {\n        (app as { use: (plugin: unknown) => void }).use(createDevicePlugin(detector, {\n          globalPropertyName,\n          registerComponents,\n          registerDirectives,\n        }))\n      }\n\n      if (debug) {\n        console.log('[Device Plugin] Installed successfully')\n        console.log('[Device Plugin] Device Info:', detector.getDeviceInfo())\n      }\n    },\n\n    async uninstall(context: PluginContext) {\n      const { engine } = context\n\n      // 清理资源\n      const detector = engine.state.get('device:instance') as DeviceDetector | undefined\n      if (detector && typeof detector.destroy === 'function') {\n        detector.destroy()\n      }\n\n      // 清理状态\n      engine.state.delete('device:instance')\n      engine.state.delete('device:info')\n\n      // 注销 API\n      engine.api.unregister('device')\n    },\n  }\n}\n\n/**\n * 默认 Device Engine 插件\n */\nexport const devicePlugin = createDeviceEnginePlugin()\n\n"],"names":["createDeviceEnginePlugin","options","name","version","debug","enableResize","enableOrientation","modules","globalPropertyName","registerComponents","registerDirectives","install","context","engine","console","log","detector","CoreDeviceDetector","moduleName","loadModule","error","warn","state","set","getDeviceInfo","api","register","getInstance","getDeviceType","type","isMobile","isTablet","isDesktop","refresh","info","on","events","emit","orientation","app","getApp","use","createDevicePlugin","uninstall","get","destroy","delete","unregister","devicePlugin"],"mappings":"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"}