<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ldesign/device E2E Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      .info-card {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      .info-item {
        margin: 10px 0;
      }

      .label {
        font-weight: bold;
        display: inline-block;
        width: 150px;
      }

      .value {
        color: #007acc;
      }

      .device-specific {
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }

      .mobile {
        background: #e8f5e8;
        border-left: 4px solid #4caf50;
      }

      .tablet {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
      }

      .desktop {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
      }

      .button {
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }

      .button:hover {
        background: #005a9e;
      }

      .log {
        background: #f8f8f8;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>@ldesign/device E2E Test Page</h1>

      <div class="info-card">
        <h2>è®¾å¤‡ä¿¡æ¯</h2>
        <div id="device-info"></div>
      </div>

      <div class="info-card">
        <h2>æ‰©å±•æ¨¡å—</h2>
        <div>
          <button class="button" onclick="loadNetworkModule()">åŠ è½½ç½‘ç»œæ¨¡å—</button>
          <button class="button" onclick="loadBatteryModule()">åŠ è½½ç”µæ± æ¨¡å—</button>
          <button class="button" onclick="loadGeolocationModule()">åŠ è½½åœ°ç†ä½ç½®æ¨¡å—</button>
          <button class="button" onclick="unloadAllModules()">å¸è½½æ‰€æœ‰æ¨¡å—</button>
        </div>
        <div id="module-info"></div>
      </div>

      <div class="info-card">
        <h2>äº‹ä»¶æ—¥å¿—</h2>
        <div>
          <button class="button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
          <button class="button" onclick="refreshDevice()">åˆ·æ–°è®¾å¤‡ä¿¡æ¯</button>
        </div>
        <div id="event-log" class="log"></div>
      </div>

      <div id="device-specific-content"></div>
    </div>

    <!-- åŠ è½½æ„å»ºåçš„åº“æ–‡ä»¶ -->
    <script src="../dist/index.js"></script>

    <script>
      // å…¨å±€å˜é‡
      let detector = null
      let eventLog = []

      // åˆå§‹åŒ–
      function init() {
        try {
          // åˆ›å»ºè®¾å¤‡æ£€æµ‹å™¨
          detector = new LDesignDevice.DeviceDetector({
            debounceDelay: 100, // å‡å°‘é˜²æŠ–å»¶è¿Ÿä»¥ä¾¿æµ‹è¯•
          })

          // ç›‘å¬æ‰€æœ‰äº‹ä»¶
          detector.on('deviceChange', (info) => {
            logEvent('deviceChange', info)
            updateDeviceInfo()
            updateDeviceSpecificContent()
          })

          detector.on('deviceTypeChange', (type) => {
            logEvent('deviceTypeChange', { type })
          })

          detector.on('orientationChange', (orientation) => {
            logEvent('orientationChange', { orientation })
          })

          // åˆå§‹æ›´æ–°
          updateDeviceInfo()
          updateDeviceSpecificContent()

          logEvent('init', { message: 'è®¾å¤‡æ£€æµ‹å™¨åˆå§‹åŒ–æˆåŠŸ' })
        } catch (error) {
          logEvent('error', { message: error.message })
        }
      }

      // æ›´æ–°è®¾å¤‡ä¿¡æ¯æ˜¾ç¤º
      function updateDeviceInfo() {
        if (!detector) return

        const deviceInfo = detector.getDeviceInfo()
        const html = `
        <div class="info-item">
          <span class="label">è®¾å¤‡ç±»å‹:</span>
          <span class="value">${deviceInfo.type}</span>
        </div>
        <div class="info-item">
          <span class="label">å±å¹•æ–¹å‘:</span>
          <span class="value">${deviceInfo.orientation}</span>
        </div>
        <div class="info-item">
          <span class="label">å±å¹•å°ºå¯¸:</span>
          <span class="value">${deviceInfo.width} x ${deviceInfo.height}</span>
        </div>
        <div class="info-item">
          <span class="label">åƒç´ æ¯”:</span>
          <span class="value">${deviceInfo.pixelRatio}</span>
        </div>
        <div class="info-item">
          <span class="label">è§¦æ‘¸è®¾å¤‡:</span>
          <span class="value">${deviceInfo.isTouchDevice ? 'æ˜¯' : 'å¦'}</span>
        </div>
        <div class="info-item">
          <span class="label">æ“ä½œç³»ç»Ÿ:</span>
          <span class="value">${deviceInfo.os.name} ${deviceInfo.os.version}</span>
        </div>
        <div class="info-item">
          <span class="label">æµè§ˆå™¨:</span>
          <span class="value">${deviceInfo.browser.name} ${deviceInfo.browser.version}</span>
        </div>
        <div class="info-item">
          <span class="label">User Agent:</span>
          <span class="value" style="word-break: break-all; font-size: 12px;">${deviceInfo.userAgent}</span>
        </div>
      `

        document.getElementById('device-info').innerHTML = html
      }

      // æ›´æ–°è®¾å¤‡ç‰¹å®šå†…å®¹
      function updateDeviceSpecificContent() {
        if (!detector) return

        const deviceType = detector.getDeviceType()
        let content = ''

        if (detector.isMobile()) {
          content = `
          <div class="device-specific mobile">
            <h3>ğŸ“± ç§»åŠ¨è®¾å¤‡æ£€æµ‹åˆ°</h3>
            <p>å½“å‰è®¾å¤‡è¢«è¯†åˆ«ä¸ºç§»åŠ¨è®¾å¤‡ã€‚è¿™é‡Œå¯ä»¥æ˜¾ç¤ºç§»åŠ¨è®¾å¤‡ä¸“ç”¨çš„å†…å®¹å’ŒåŠŸèƒ½ã€‚</p>
          </div>
        `
        } else if (detector.isTablet()) {
          content = `
          <div class="device-specific tablet">
            <h3>ğŸ“± å¹³æ¿è®¾å¤‡æ£€æµ‹åˆ°</h3>
            <p>å½“å‰è®¾å¤‡è¢«è¯†åˆ«ä¸ºå¹³æ¿è®¾å¤‡ã€‚è¿™é‡Œå¯ä»¥æ˜¾ç¤ºå¹³æ¿è®¾å¤‡ä¸“ç”¨çš„å†…å®¹å’ŒåŠŸèƒ½ã€‚</p>
          </div>
        `
        } else if (detector.isDesktop()) {
          content = `
          <div class="device-specific desktop">
            <h3>ğŸ–¥ï¸ æ¡Œé¢è®¾å¤‡æ£€æµ‹åˆ°</h3>
            <p>å½“å‰è®¾å¤‡è¢«è¯†åˆ«ä¸ºæ¡Œé¢è®¾å¤‡ã€‚è¿™é‡Œå¯ä»¥æ˜¾ç¤ºæ¡Œé¢è®¾å¤‡ä¸“ç”¨çš„å†…å®¹å’ŒåŠŸèƒ½ã€‚</p>
          </div>
        `
        }

        document.getElementById('device-specific-content').innerHTML = content
      }

      // åŠ è½½ç½‘ç»œæ¨¡å—
      async function loadNetworkModule() {
        try {
          await detector.loadModule('network', LDesignDevice.NetworkModule)
          logEvent('module', { message: 'ç½‘ç»œæ¨¡å—åŠ è½½æˆåŠŸ' })
          updateModuleInfo()
        } catch (error) {
          logEvent('error', { message: `ç½‘ç»œæ¨¡å—åŠ è½½å¤±è´¥: ${error.message}` })
        }
      }

      // åŠ è½½ç”µæ± æ¨¡å—
      async function loadBatteryModule() {
        try {
          await detector.loadModule('battery', LDesignDevice.BatteryModule)
          logEvent('module', { message: 'ç”µæ± æ¨¡å—åŠ è½½æˆåŠŸ' })
          updateModuleInfo()
        } catch (error) {
          logEvent('error', { message: `ç”µæ± æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}` })
        }
      }

      // åŠ è½½åœ°ç†ä½ç½®æ¨¡å—
      async function loadGeolocationModule() {
        try {
          await detector.loadModule('geolocation', LDesignDevice.GeolocationModule)
          logEvent('module', { message: 'åœ°ç†ä½ç½®æ¨¡å—åŠ è½½æˆåŠŸ' })
          updateModuleInfo()
        } catch (error) {
          logEvent('error', { message: `åœ°ç†ä½ç½®æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}` })
        }
      }

      // å¸è½½æ‰€æœ‰æ¨¡å—
      async function unloadAllModules() {
        try {
          const loadedModules = detector.getLoadedModules()
          for (const moduleName of loadedModules) {
            await detector.unloadModule(moduleName)
          }
          logEvent('module', { message: 'æ‰€æœ‰æ¨¡å—å·²å¸è½½' })
          updateModuleInfo()
        } catch (error) {
          logEvent('error', { message: `æ¨¡å—å¸è½½å¤±è´¥: ${error.message}` })
        }
      }

      // æ›´æ–°æ¨¡å—ä¿¡æ¯æ˜¾ç¤º
      function updateModuleInfo() {
        if (!detector) return

        const loadedModules = detector.getLoadedModules()
        let html = `
        <div class="info-item">
          <span class="label">å·²åŠ è½½æ¨¡å—:</span>
          <span class="value">${loadedModules.length > 0 ? loadedModules.join(', ') : 'æ— '}</span>
        </div>
      `

        // ç½‘ç»œæ¨¡å—ä¿¡æ¯
        if (detector.isModuleLoaded('network')) {
          const networkModule = detector.getModule('network')
          const networkInfo = networkModule.getNetworkInfo()
          html += `
          <div class="info-item">
            <span class="label">ç½‘ç»œçŠ¶æ€:</span>
            <span class="value">${networkInfo.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}</span>
          </div>
          <div class="info-item">
            <span class="label">è¿æ¥ç±»å‹:</span>
            <span class="value">${networkInfo.type || 'æœªçŸ¥'}</span>
          </div>
          <div class="info-item">
            <span class="label">ä¸‹è½½é€Ÿåº¦:</span>
            <span class="value">${networkInfo.downlink || 'æœªçŸ¥'} Mbps</span>
          </div>
        `
        }

        // ç”µæ± æ¨¡å—ä¿¡æ¯
        if (detector.isModuleLoaded('battery')) {
          const batteryModule = detector.getModule('battery')
          const batteryInfo = batteryModule.getBatteryInfo()
          if (batteryInfo.level !== null) {
            html += `
            <div class="info-item">
              <span class="label">ç”µæ± ç”µé‡:</span>
              <span class="value">${Math.round(batteryInfo.level * 100)}%</span>
            </div>
            <div class="info-item">
              <span class="label">å……ç”µçŠ¶æ€:</span>
              <span class="value">${batteryInfo.charging ? 'å……ç”µä¸­' : 'æœªå……ç”µ'}</span>
            </div>
          `
          } else {
            html += `
            <div class="info-item">
              <span class="label">ç”µæ± ä¿¡æ¯:</span>
              <span class="value">ä¸æ”¯æŒæˆ–æ— æ³•è·å–</span>
            </div>
          `
          }
        }

        // åœ°ç†ä½ç½®æ¨¡å—ä¿¡æ¯
        if (detector.isModuleLoaded('geolocation')) {
          const geolocationModule = detector.getModule('geolocation')
          const position = geolocationModule.getPosition()
          if (position.latitude !== null) {
            html += `
            <div class="info-item">
              <span class="label">çº¬åº¦:</span>
              <span class="value">${position.latitude.toFixed(6)}</span>
            </div>
            <div class="info-item">
              <span class="label">ç»åº¦:</span>
              <span class="value">${position.longitude.toFixed(6)}</span>
            </div>
            <div class="info-item">
              <span class="label">ç²¾åº¦:</span>
              <span class="value">${position.accuracy} ç±³</span>
            </div>
          `
          } else {
            html += `
            <div class="info-item">
              <span class="label">ä½ç½®ä¿¡æ¯:</span>
              <span class="value">æœªè·å–</span>
            </div>
          `
          }
        }

        document.getElementById('module-info').innerHTML = html
      }

      // åˆ·æ–°è®¾å¤‡ä¿¡æ¯
      function refreshDevice() {
        if (detector) {
          detector.refresh()
          logEvent('refresh', { message: 'è®¾å¤‡ä¿¡æ¯å·²åˆ·æ–°' })
        }
      }

      // è®°å½•äº‹ä»¶
      function logEvent(type, data) {
        const timestamp = new Date().toLocaleTimeString()
        const logEntry = {
          timestamp,
          type,
          data,
        }

        eventLog.unshift(logEntry)

        // é™åˆ¶æ—¥å¿—æ¡æ•°
        if (eventLog.length > 50) {
          eventLog = eventLog.slice(0, 50)
        }

        updateEventLog()
      }

      // æ›´æ–°äº‹ä»¶æ—¥å¿—æ˜¾ç¤º
      function updateEventLog() {
        const logHtml = eventLog
          .map((entry) => {
            const dataStr = typeof entry.data === 'object' ? JSON.stringify(entry.data, null, 2) : entry.data
            return `[${entry.timestamp}] ${entry.type}: ${dataStr}`
          })
          .join('\n')

        document.getElementById('event-log').textContent = logHtml
      }

      // æ¸…ç©ºæ—¥å¿—
      function clearLog() {
        eventLog = []
        updateEventLog()
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', init)

      // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
      window.addEventListener('beforeunload', async () => {
        if (detector) {
          await detector.destroy()
        }
      })
    </script>
  </body>
</html>
