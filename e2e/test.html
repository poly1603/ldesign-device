<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ldesign/device E2E Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      .info-card {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      .info-item {
        margin: 10px 0;
      }

      .label {
        font-weight: bold;
        display: inline-block;
        width: 150px;
      }

      .value {
        color: #007acc;
      }

      .device-specific {
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }

      .mobile {
        background: #e8f5e8;
        border-left: 4px solid #4caf50;
      }

      .tablet {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
      }

      .desktop {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
      }

      .button {
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }

      .button:hover {
        background: #005a9e;
      }

      .log {
        background: #f8f8f8;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>@ldesign/device E2E Test Page</h1>

      <div class="info-card">
        <h2>设备信息</h2>
        <div id="device-info"></div>
      </div>

      <div class="info-card">
        <h2>扩展模块</h2>
        <div>
          <button class="button" onclick="loadNetworkModule()">加载网络模块</button>
          <button class="button" onclick="loadBatteryModule()">加载电池模块</button>
          <button class="button" onclick="loadGeolocationModule()">加载地理位置模块</button>
          <button class="button" onclick="unloadAllModules()">卸载所有模块</button>
        </div>
        <div id="module-info"></div>
      </div>

      <div class="info-card">
        <h2>事件日志</h2>
        <div>
          <button class="button" onclick="clearLog()">清空日志</button>
          <button class="button" onclick="refreshDevice()">刷新设备信息</button>
        </div>
        <div id="event-log" class="log"></div>
      </div>

      <div id="device-specific-content"></div>
    </div>

    <!-- 加载构建后的库文件 -->
    <script src="../dist/index.js"></script>

    <script>
      // 全局变量
      let detector = null
      let eventLog = []

      // 初始化
      function init() {
        try {
          // 创建设备检测器
          detector = new LDesignDevice.DeviceDetector({
            debounceDelay: 100, // 减少防抖延迟以便测试
          })

          // 监听所有事件
          detector.on('deviceChange', (info) => {
            logEvent('deviceChange', info)
            updateDeviceInfo()
            updateDeviceSpecificContent()
          })

          detector.on('deviceTypeChange', (type) => {
            logEvent('deviceTypeChange', { type })
          })

          detector.on('orientationChange', (orientation) => {
            logEvent('orientationChange', { orientation })
          })

          // 初始更新
          updateDeviceInfo()
          updateDeviceSpecificContent()

          logEvent('init', { message: '设备检测器初始化成功' })
        } catch (error) {
          logEvent('error', { message: error.message })
        }
      }

      // 更新设备信息显示
      function updateDeviceInfo() {
        if (!detector) return

        const deviceInfo = detector.getDeviceInfo()
        const html = `
        <div class="info-item">
          <span class="label">设备类型:</span>
          <span class="value">${deviceInfo.type}</span>
        </div>
        <div class="info-item">
          <span class="label">屏幕方向:</span>
          <span class="value">${deviceInfo.orientation}</span>
        </div>
        <div class="info-item">
          <span class="label">屏幕尺寸:</span>
          <span class="value">${deviceInfo.width} x ${deviceInfo.height}</span>
        </div>
        <div class="info-item">
          <span class="label">像素比:</span>
          <span class="value">${deviceInfo.pixelRatio}</span>
        </div>
        <div class="info-item">
          <span class="label">触摸设备:</span>
          <span class="value">${deviceInfo.isTouchDevice ? '是' : '否'}</span>
        </div>
        <div class="info-item">
          <span class="label">操作系统:</span>
          <span class="value">${deviceInfo.os.name} ${deviceInfo.os.version}</span>
        </div>
        <div class="info-item">
          <span class="label">浏览器:</span>
          <span class="value">${deviceInfo.browser.name} ${deviceInfo.browser.version}</span>
        </div>
        <div class="info-item">
          <span class="label">User Agent:</span>
          <span class="value" style="word-break: break-all; font-size: 12px;">${deviceInfo.userAgent}</span>
        </div>
      `

        document.getElementById('device-info').innerHTML = html
      }

      // 更新设备特定内容
      function updateDeviceSpecificContent() {
        if (!detector) return

        const deviceType = detector.getDeviceType()
        let content = ''

        if (detector.isMobile()) {
          content = `
          <div class="device-specific mobile">
            <h3>📱 移动设备检测到</h3>
            <p>当前设备被识别为移动设备。这里可以显示移动设备专用的内容和功能。</p>
          </div>
        `
        } else if (detector.isTablet()) {
          content = `
          <div class="device-specific tablet">
            <h3>📱 平板设备检测到</h3>
            <p>当前设备被识别为平板设备。这里可以显示平板设备专用的内容和功能。</p>
          </div>
        `
        } else if (detector.isDesktop()) {
          content = `
          <div class="device-specific desktop">
            <h3>🖥️ 桌面设备检测到</h3>
            <p>当前设备被识别为桌面设备。这里可以显示桌面设备专用的内容和功能。</p>
          </div>
        `
        }

        document.getElementById('device-specific-content').innerHTML = content
      }

      // 加载网络模块
      async function loadNetworkModule() {
        try {
          await detector.loadModule('network', LDesignDevice.NetworkModule)
          logEvent('module', { message: '网络模块加载成功' })
          updateModuleInfo()
        } catch (error) {
          logEvent('error', { message: `网络模块加载失败: ${error.message}` })
        }
      }

      // 加载电池模块
      async function loadBatteryModule() {
        try {
          await detector.loadModule('battery', LDesignDevice.BatteryModule)
          logEvent('module', { message: '电池模块加载成功' })
          updateModuleInfo()
        } catch (error) {
          logEvent('error', { message: `电池模块加载失败: ${error.message}` })
        }
      }

      // 加载地理位置模块
      async function loadGeolocationModule() {
        try {
          await detector.loadModule('geolocation', LDesignDevice.GeolocationModule)
          logEvent('module', { message: '地理位置模块加载成功' })
          updateModuleInfo()
        } catch (error) {
          logEvent('error', { message: `地理位置模块加载失败: ${error.message}` })
        }
      }

      // 卸载所有模块
      async function unloadAllModules() {
        try {
          const loadedModules = detector.getLoadedModules()
          for (const moduleName of loadedModules) {
            await detector.unloadModule(moduleName)
          }
          logEvent('module', { message: '所有模块已卸载' })
          updateModuleInfo()
        } catch (error) {
          logEvent('error', { message: `模块卸载失败: ${error.message}` })
        }
      }

      // 更新模块信息显示
      function updateModuleInfo() {
        if (!detector) return

        const loadedModules = detector.getLoadedModules()
        let html = `
        <div class="info-item">
          <span class="label">已加载模块:</span>
          <span class="value">${loadedModules.length > 0 ? loadedModules.join(', ') : '无'}</span>
        </div>
      `

        // 网络模块信息
        if (detector.isModuleLoaded('network')) {
          const networkModule = detector.getModule('network')
          const networkInfo = networkModule.getNetworkInfo()
          html += `
          <div class="info-item">
            <span class="label">网络状态:</span>
            <span class="value">${networkInfo.isOnline ? '在线' : '离线'}</span>
          </div>
          <div class="info-item">
            <span class="label">连接类型:</span>
            <span class="value">${networkInfo.type || '未知'}</span>
          </div>
          <div class="info-item">
            <span class="label">下载速度:</span>
            <span class="value">${networkInfo.downlink || '未知'} Mbps</span>
          </div>
        `
        }

        // 电池模块信息
        if (detector.isModuleLoaded('battery')) {
          const batteryModule = detector.getModule('battery')
          const batteryInfo = batteryModule.getBatteryInfo()
          if (batteryInfo.level !== null) {
            html += `
            <div class="info-item">
              <span class="label">电池电量:</span>
              <span class="value">${Math.round(batteryInfo.level * 100)}%</span>
            </div>
            <div class="info-item">
              <span class="label">充电状态:</span>
              <span class="value">${batteryInfo.charging ? '充电中' : '未充电'}</span>
            </div>
          `
          } else {
            html += `
            <div class="info-item">
              <span class="label">电池信息:</span>
              <span class="value">不支持或无法获取</span>
            </div>
          `
          }
        }

        // 地理位置模块信息
        if (detector.isModuleLoaded('geolocation')) {
          const geolocationModule = detector.getModule('geolocation')
          const position = geolocationModule.getPosition()
          if (position.latitude !== null) {
            html += `
            <div class="info-item">
              <span class="label">纬度:</span>
              <span class="value">${position.latitude.toFixed(6)}</span>
            </div>
            <div class="info-item">
              <span class="label">经度:</span>
              <span class="value">${position.longitude.toFixed(6)}</span>
            </div>
            <div class="info-item">
              <span class="label">精度:</span>
              <span class="value">${position.accuracy} 米</span>
            </div>
          `
          } else {
            html += `
            <div class="info-item">
              <span class="label">位置信息:</span>
              <span class="value">未获取</span>
            </div>
          `
          }
        }

        document.getElementById('module-info').innerHTML = html
      }

      // 刷新设备信息
      function refreshDevice() {
        if (detector) {
          detector.refresh()
          logEvent('refresh', { message: '设备信息已刷新' })
        }
      }

      // 记录事件
      function logEvent(type, data) {
        const timestamp = new Date().toLocaleTimeString()
        const logEntry = {
          timestamp,
          type,
          data,
        }

        eventLog.unshift(logEntry)

        // 限制日志条数
        if (eventLog.length > 50) {
          eventLog = eventLog.slice(0, 50)
        }

        updateEventLog()
      }

      // 更新事件日志显示
      function updateEventLog() {
        const logHtml = eventLog
          .map((entry) => {
            const dataStr = typeof entry.data === 'object' ? JSON.stringify(entry.data, null, 2) : entry.data
            return `[${entry.timestamp}] ${entry.type}: ${dataStr}`
          })
          .join('\n')

        document.getElementById('event-log').textContent = logHtml
      }

      // 清空日志
      function clearLog() {
        eventLog = []
        updateEventLog()
      }

      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', init)

      // 页面卸载时清理资源
      window.addEventListener('beforeunload', async () => {
        if (detector) {
          await detector.destroy()
        }
      })
    </script>
  </body>
</html>
