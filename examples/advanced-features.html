<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>@ldesign/device é«˜çº§åŠŸèƒ½ç¤ºä¾‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .feature-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .feature-card h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .feature-card h2 .icon {
      font-size: 1.8rem;
    }

    .info-list {
      list-style: none;
      margin: 15px 0;
    }

    .info-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-list li:last-child {
      border-bottom: none;
    }

    .label {
      color: #666;
      font-weight: 500;
    }

    .value {
      color: #333;
      font-weight: 600;
      background: #f0f0f0;
      padding: 4px 10px;
      border-radius: 4px;
    }

    .value.success {
      background: #d4edda;
      color: #155724;
    }

    .value.warning {
      background: #fff3cd;
      color: #856404;
    }

    .value.danger {
      background: #f8d7da;
      color: #721c24;
    }

    .value.info {
      background: #d1ecf1;
      color: #0c5460;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 5px;
    }

    button:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .device-list {
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .device-item {
      padding: 8px;
      margin: 5px 0;
      background: white;
      border-radius: 4px;
      border-left: 4px solid #667eea;
    }

    .console-output {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }

    .console-line {
      margin: 5px 0;
      padding: 3px 0;
    }

    .console-line.info {
      color: #66d9ef;
    }

    .console-line.success {
      color: #a6e22e;
    }

    .console-line.error {
      color: #f92672;
    }

    .console-line.warning {
      color: #fd971f;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .performance-graph {
      height: 200px;
      background: #f8f9fa;
      border-radius: 4px;
      padding: 10px;
      position: relative;
      overflow: hidden;
    }

    .performance-bar {
      position: absolute;
      bottom: 0;
      width: 30px;
      background: linear-gradient(to top, #667eea, #764ba2);
      transition: height 0.3s;
      border-radius: 4px 4px 0 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ @ldesign/device é«˜çº§åŠŸèƒ½ç¤ºä¾‹</h1>

    <div class="feature-grid">
      <!-- åª’ä½“è®¾å¤‡æ£€æµ‹ -->
      <div class="feature-card">
        <h2><span class="icon">ğŸ“·</span>åª’ä½“è®¾å¤‡æ£€æµ‹</h2>
        <ul class="info-list">
          <li>
            <span class="label">æ‘„åƒå¤´</span>
            <span id="camera-status" class="value">æ£€æµ‹ä¸­...</span>
          </li>
          <li>
            <span class="label">éº¦å…‹é£</span>
            <span id="mic-status" class="value">æ£€æµ‹ä¸­...</span>
          </li>
          <li>
            <span class="label">æ‰¬å£°å™¨</span>
            <span id="speaker-status" class="value">æ£€æµ‹ä¸­...</span>
          </li>
          <li>
            <span class="label">æ‘„åƒå¤´æƒé™</span>
            <span id="camera-permission" class="value">æœªçŸ¥</span>
          </li>
          <li>
            <span class="label">éº¦å…‹é£æƒé™</span>
            <span id="mic-permission" class="value">æœªçŸ¥</span>
          </li>
        </ul>
        <div id="device-list" class="device-list"></div>
        <div class="button-group">
          <button onclick="requestCameraPermission()">è¯·æ±‚æ‘„åƒå¤´æƒé™</button>
          <button onclick="requestMicPermission()">è¯·æ±‚éº¦å…‹é£æƒé™</button>
          <button onclick="testCamera()">æµ‹è¯•æ‘„åƒå¤´</button>
          <button onclick="testMicrophone()">æµ‹è¯•éº¦å…‹é£</button>
        </div>
      </div>

      <!-- æ€§èƒ½ä¼˜åŒ–æ¼”ç¤º -->
      <div class="feature-card">
        <h2><span class="icon">âš¡</span>æ€§èƒ½ä¼˜åŒ–å·¥å…·</h2>
        <ul class="info-list">
          <li>
            <span class="label">é˜²æŠ–è®¡æ•°</span>
            <span id="debounce-count" class="value info">0</span>
          </li>
          <li>
            <span class="label">èŠ‚æµè®¡æ•°</span>
            <span id="throttle-count" class="value info">0</span>
          </li>
          <li>
            <span class="label">ç¼“å­˜å‘½ä¸­ç‡</span>
            <span id="cache-hit-rate" class="value success">0%</span>
          </li>
          <li>
            <span class="label">æ‰¹å¤„ç†å¤§å°</span>
            <span id="batch-size" class="value warning">0</span>
          </li>
        </ul>
        <div class="button-group">
          <button onclick="testDebounce()">æµ‹è¯•é˜²æŠ–ï¼ˆå¿«é€Ÿç‚¹å‡»ï¼‰</button>
          <button onclick="testThrottle()">æµ‹è¯•èŠ‚æµï¼ˆå¿«é€Ÿç‚¹å‡»ï¼‰</button>
          <button onclick="testCache()">æµ‹è¯•ç¼“å­˜</button>
          <button onclick="testBatch()">æµ‹è¯•æ‰¹å¤„ç†</button>
        </div>
        <div id="performance-graph" class="performance-graph"></div>
      </div>

      <!-- è®¾å¤‡ä¿¡æ¯å¢å¼º -->
      <div class="feature-card">
        <h2><span class="icon">ğŸ“±</span>è®¾å¤‡ä¿¡æ¯å¢å¼º</h2>
        <ul class="info-list">
          <li>
            <span class="label">WebGL æ”¯æŒ</span>
            <span id="webgl-support" class="value">æ£€æµ‹ä¸­...</span>
          </li>
          <li>
            <span class="label">è§¦æ‘¸æ”¯æŒ</span>
            <span id="touch-support" class="value">æ£€æµ‹ä¸­...</span>
          </li>
          <li>
            <span class="label">å±å¹•å°ºå¯¸</span>
            <span id="screen-size" class="value">æ£€æµ‹ä¸­...</span>
          </li>
          <li>
            <span class="label">å¯ç”¨åŒºåŸŸ</span>
            <span id="available-size" class="value">æ£€æµ‹ä¸­...</span>
          </li>
          <li>
            <span class="label">åƒç´ å¯†åº¦</span>
            <span id="pixel-ratio" class="value">æ£€æµ‹ä¸­...</span>
          </li>
          <li>
            <span class="label">æµè§ˆå™¨å¼•æ“</span>
            <span id="browser-engine" class="value">æ£€æµ‹ä¸­...</span>
          </li>
        </ul>
        <div class="button-group">
          <button onclick="refreshDeviceInfo()">åˆ·æ–°ä¿¡æ¯</button>
          <button onclick="testWebGL()">æµ‹è¯• WebGL æ¸²æŸ“</button>
        </div>
      </div>

      <!-- æ‡’åŠ è½½ç®¡ç† -->
      <div class="feature-card">
        <h2><span class="icon">ğŸ“¦</span>æ¨¡å—æ‡’åŠ è½½</h2>
        <ul class="info-list">
          <li>
            <span class="label">ç½‘ç»œæ¨¡å—</span>
            <span id="network-module" class="value">æœªåŠ è½½</span>
          </li>
          <li>
            <span class="label">ç”µæ± æ¨¡å—</span>
            <span id="battery-module" class="value">æœªåŠ è½½</span>
          </li>
          <li>
            <span class="label">åœ°ç†ä½ç½®æ¨¡å—</span>
            <span id="geolocation-module" class="value">æœªåŠ è½½</span>
          </li>
          <li>
            <span class="label">åª’ä½“æ¨¡å—</span>
            <span id="media-module" class="value">æœªåŠ è½½</span>
          </li>
        </ul>
        <div class="button-group">
          <button onclick="loadModule('network')">åŠ è½½ç½‘ç»œæ¨¡å—</button>
          <button onclick="loadModule('battery')">åŠ è½½ç”µæ± æ¨¡å—</button>
          <button onclick="loadModule('geolocation')">åŠ è½½åœ°ç†ä½ç½®æ¨¡å—</button>
          <button onclick="preloadAllModules()">é¢„åŠ è½½æ‰€æœ‰æ¨¡å—</button>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶å°è¾“å‡º -->
    <div class="console-output" id="console">
      <div class="console-line info">ğŸš€ @ldesign/device é«˜çº§åŠŸèƒ½ç¤ºä¾‹å·²å¯åŠ¨</div>
      <div class="console-line info">ğŸ“¦ æ­£åœ¨åˆå§‹åŒ–è®¾å¤‡æ£€æµ‹å™¨...</div>
    </div>
  </div>

  <script type="module">
    // å¯¼å…¥ @ldesign/device æ¨¡å—
    import { DeviceDetector } from '../es/core/DeviceDetector.js'
    import { MediaModule } from '../es/modules/MediaModule.js'
    import { 
      debounce, 
      throttle, 
      MemoryCache, 
      memoize, 
      LazyLoader,
      BatchExecutor 
    } from '../es/utils/performance.js'

    // å…¨å±€å˜é‡
    window.detector = null
    window.mediaModule = null
    window.cache = new MemoryCache({ maxSize: 50, defaultTTL: 60000 })
    window.lazyLoader = new LazyLoader()
    window.batchExecutor = null

    // æ§åˆ¶å°æ—¥å¿—
    function log(message, type = 'info') {
      const console = document.getElementById('console')
      const line = document.createElement('div')
      line.className = `console-line ${type}`
      const time = new Date().toLocaleTimeString()
      line.textContent = `[${time}] ${message}`
      console.appendChild(line)
      console.scrollTop = console.scrollHeight
    }

    // åˆå§‹åŒ–
    async function init() {
      try {
        // åˆ›å»ºè®¾å¤‡æ£€æµ‹å™¨
        window.detector = new DeviceDetector({
          enableResize: true,
          enableOrientation: true
        })
        log('âœ… è®¾å¤‡æ£€æµ‹å™¨åˆå§‹åŒ–æˆåŠŸ', 'success')

        // åˆ›å»ºåª’ä½“æ¨¡å—
        window.mediaModule = new MediaModule()
        await window.mediaModule.init()
        log('âœ… åª’ä½“æ¨¡å—åˆå§‹åŒ–æˆåŠŸ', 'success')

        // æ›´æ–°è®¾å¤‡ä¿¡æ¯
        updateDeviceInfo()
        updateMediaInfo()

        // ç›‘å¬äº‹ä»¶
        window.mediaModule.on('deviceChange', (info) => {
          log('ğŸ“· æ£€æµ‹åˆ°åª’ä½“è®¾å¤‡å˜åŒ–', 'warning')
          updateMediaInfo()
        })

        window.mediaModule.on('permissionChange', (change) => {
          log(`ğŸ” ${change.type} æƒé™å˜æ›´ä¸º: ${change.state}`, 'warning')
          updateMediaInfo()
        })

        // åˆå§‹åŒ–æ‰¹å¤„ç†æ‰§è¡Œå™¨
        window.batchExecutor = new BatchExecutor(
          async (batch) => {
            log(`âš¡ æ‰¹å¤„ç†æ‰§è¡Œï¼Œæ‰¹å¤§å°: ${batch.length}`, 'info')
            return batch.map(x => x * 2)
          },
          { maxBatchSize: 5, maxWaitTime: 1000 }
        )

        // æ³¨å†Œæ‡’åŠ è½½æ¨¡å—
        registerLazyModules()

      } catch (error) {
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error')
      }
    }

    // æ›´æ–°è®¾å¤‡ä¿¡æ¯
    function updateDeviceInfo() {
      const info = window.detector.getDeviceInfo()
      
      document.getElementById('webgl-support').textContent = info.features.webgl ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'
      document.getElementById('webgl-support').className = `value ${info.features.webgl ? 'success' : 'danger'}`
      
      document.getElementById('touch-support').textContent = info.features.touch ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'
      document.getElementById('touch-support').className = `value ${info.features.touch ? 'success' : 'warning'}`
      
      document.getElementById('screen-size').textContent = `${info.screen.width} Ã— ${info.screen.height}`
      document.getElementById('available-size').textContent = `${info.screen.availWidth} Ã— ${info.screen.availHeight}`
      document.getElementById('pixel-ratio').textContent = info.screen.pixelRatio.toFixed(2)
      document.getElementById('browser-engine').textContent = info.browser.engine || 'æœªçŸ¥'
    }

    // æ›´æ–°åª’ä½“ä¿¡æ¯
    function updateMediaInfo() {
      const info = window.mediaModule.getData()
      
      document.getElementById('camera-status').textContent = info.hasCamera ? `${info.cameras.length} ä¸ª` : 'æ— '
      document.getElementById('camera-status').className = `value ${info.hasCamera ? 'success' : 'warning'}`
      
      document.getElementById('mic-status').textContent = info.hasMicrophone ? `${info.microphones.length} ä¸ª` : 'æ— '
      document.getElementById('mic-status').className = `value ${info.hasMicrophone ? 'success' : 'warning'}`
      
      document.getElementById('speaker-status').textContent = info.hasSpeaker ? `${info.speakers.length} ä¸ª` : 'æ— '
      document.getElementById('speaker-status').className = `value ${info.hasSpeaker ? 'success' : 'warning'}`
      
      document.getElementById('camera-permission').textContent = info.cameraPermission
      document.getElementById('camera-permission').className = `value ${
        info.cameraPermission === 'granted' ? 'success' : 
        info.cameraPermission === 'denied' ? 'danger' : 'warning'
      }`
      
      document.getElementById('mic-permission').textContent = info.microphonePermission
      document.getElementById('mic-permission').className = `value ${
        info.microphonePermission === 'granted' ? 'success' : 
        info.microphonePermission === 'denied' ? 'danger' : 'warning'
      }`

      // æ›´æ–°è®¾å¤‡åˆ—è¡¨
      const deviceList = document.getElementById('device-list')
      deviceList.innerHTML = ''
      
      info.cameras.forEach(camera => {
        const item = document.createElement('div')
        item.className = 'device-item'
        item.textContent = `ğŸ“· ${camera.label || camera.deviceId}`
        deviceList.appendChild(item)
      })
      
      info.microphones.forEach(mic => {
        const item = document.createElement('div')
        item.className = 'device-item'
        item.textContent = `ğŸ¤ ${mic.label || mic.deviceId}`
        deviceList.appendChild(item)
      })
    }

    // åª’ä½“åŠŸèƒ½
    window.requestCameraPermission = async function() {
      log('ğŸ“· è¯·æ±‚æ‘„åƒå¤´æƒé™...', 'info')
      const result = await window.mediaModule.requestCameraPermission()
      log(result ? 'âœ… æ‘„åƒå¤´æƒé™å·²æˆäºˆ' : 'âŒ æ‘„åƒå¤´æƒé™è¢«æ‹’ç»', result ? 'success' : 'error')
    }

    window.requestMicPermission = async function() {
      log('ğŸ¤ è¯·æ±‚éº¦å…‹é£æƒé™...', 'info')
      const result = await window.mediaModule.requestMicrophonePermission()
      log(result ? 'âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ' : 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»', result ? 'success' : 'error')
    }

    window.testCamera = async function() {
      log('ğŸ“· æµ‹è¯•æ‘„åƒå¤´...', 'info')
      const result = await window.mediaModule.testCamera()
      log(result ? 'âœ… æ‘„åƒå¤´å·¥ä½œæ­£å¸¸' : 'âŒ æ‘„åƒå¤´æµ‹è¯•å¤±è´¥', result ? 'success' : 'error')
    }

    window.testMicrophone = async function() {
      log('ğŸ¤ æµ‹è¯•éº¦å…‹é£...', 'info')
      const result = await window.mediaModule.testMicrophone()
      log(result ? 'âœ… éº¦å…‹é£å·¥ä½œæ­£å¸¸' : 'âŒ éº¦å…‹é£æµ‹è¯•å¤±è´¥', result ? 'success' : 'error')
    }

    // æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½
    let debounceCount = 0
    let throttleCount = 0
    let cacheHits = 0
    let cacheMisses = 0

    const debouncedFunction = debounce(() => {
      debounceCount++
      document.getElementById('debounce-count').textContent = debounceCount
      log(`â±ï¸ é˜²æŠ–å‡½æ•°æ‰§è¡Œï¼Œè®¡æ•°: ${debounceCount}`, 'info')
    }, 500)

    const throttledFunction = throttle(() => {
      throttleCount++
      document.getElementById('throttle-count').textContent = throttleCount
      log(`âš¡ èŠ‚æµå‡½æ•°æ‰§è¡Œï¼Œè®¡æ•°: ${throttleCount}`, 'info')
    }, 500)

    window.testDebounce = function() {
      debouncedFunction()
    }

    window.testThrottle = function() {
      throttledFunction()
    }

    window.testCache = function() {
      const key = `test-${Math.floor(Math.random() * 10)}`
      
      if (window.cache.has(key)) {
        cacheHits++
        log(`âœ… ç¼“å­˜å‘½ä¸­: ${key}`, 'success')
      } else {
        cacheMisses++
        const value = Math.random()
        window.cache.set(key, value)
        log(`ğŸ“ ç¼“å­˜å†™å…¥: ${key} = ${value.toFixed(4)}`, 'info')
      }
      
      const hitRate = cacheHits + cacheMisses > 0 
        ? Math.round((cacheHits / (cacheHits + cacheMisses)) * 100)
        : 0
      document.getElementById('cache-hit-rate').textContent = `${hitRate}%`
    }

    let batchCount = 0
    window.testBatch = async function() {
      batchCount++
      const result = await window.batchExecutor.add(batchCount)
      log(`ğŸ“¦ æ‰¹å¤„ç†é¡¹æ·»åŠ : ${batchCount} -> ${result}`, 'info')
      document.getElementById('batch-size').textContent = batchCount % 5 + 1
    }

    // è®¾å¤‡åŠŸèƒ½
    window.refreshDeviceInfo = function() {
      window.detector.refresh()
      updateDeviceInfo()
      log('ğŸ”„ è®¾å¤‡ä¿¡æ¯å·²åˆ·æ–°', 'info')
    }

    window.testWebGL = function() {
      const canvas = document.createElement('canvas')
      const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl')
      
      if (gl) {
        const renderer = gl.getParameter(gl.RENDERER)
        const vendor = gl.getParameter(gl.VENDOR)
        log(`âœ… WebGL æ¸²æŸ“å™¨: ${renderer}`, 'success')
        log(`âœ… WebGL ä¾›åº”å•†: ${vendor}`, 'success')
      } else {
        log('âŒ WebGL ä¸å¯ç”¨', 'error')
      }
    }

    // æ‡’åŠ è½½åŠŸèƒ½
    function registerLazyModules() {
      window.lazyLoader.register('network', async () => {
        log('ğŸ“¡ æ­£åœ¨åŠ è½½ç½‘ç»œæ¨¡å—...', 'info')
        await new Promise(resolve => setTimeout(resolve, 1000))
        const { NetworkModule } = await import('../es/modules/NetworkModule.js')
        return new NetworkModule()
      })

      window.lazyLoader.register('battery', async () => {
        log('ğŸ”‹ æ­£åœ¨åŠ è½½ç”µæ± æ¨¡å—...', 'info')
        await new Promise(resolve => setTimeout(resolve, 1000))
        const { BatteryModule } = await import('../es/modules/BatteryModule.js')
        return new BatteryModule()
      })

      window.lazyLoader.register('geolocation', async () => {
        log('ğŸ“ æ­£åœ¨åŠ è½½åœ°ç†ä½ç½®æ¨¡å—...', 'info')
        await new Promise(resolve => setTimeout(resolve, 1000))
        const { GeolocationModule } = await import('../es/modules/GeolocationModule.js')
        return new GeolocationModule()
      })
    }

    window.loadModule = async function(name) {
      try {
        document.getElementById(`${name}-module`).textContent = 'åŠ è½½ä¸­...'
        document.getElementById(`${name}-module`).className = 'value warning'
        
        const module = await window.lazyLoader.load(name)
        await module.init()
        
        document.getElementById(`${name}-module`).textContent = 'å·²åŠ è½½'
        document.getElementById(`${name}-module`).className = 'value success'
        log(`âœ… ${name} æ¨¡å—åŠ è½½æˆåŠŸ`, 'success')
      } catch (error) {
        document.getElementById(`${name}-module`).textContent = 'åŠ è½½å¤±è´¥'
        document.getElementById(`${name}-module`).className = 'value danger'
        log(`âŒ ${name} æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}`, 'error')
      }
    }

    window.preloadAllModules = async function() {
      log('ğŸ“¦ é¢„åŠ è½½æ‰€æœ‰æ¨¡å—...', 'info')
      await window.lazyLoader.preload(['network', 'battery', 'geolocation'])
      
      for (const name of ['network', 'battery', 'geolocation']) {
        document.getElementById(`${name}-module`).textContent = 'å·²é¢„åŠ è½½'
        document.getElementById(`${name}-module`).className = 'value info'
      }
      
      log('âœ… æ‰€æœ‰æ¨¡å—é¢„åŠ è½½å®Œæˆ', 'success')
    }

    // å¯åŠ¨åº”ç”¨
    init()
  </script>
</body>
</html>
